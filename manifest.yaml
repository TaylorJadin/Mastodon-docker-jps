type: install
id: mastodon-docker
version: '1.0'
appVersion: latest
name: Mastodon
baseUrl: https://raw.githubusercontent.com/TaylorJadin/masotodon-docker-jps/main/
logo: /mastodon-logo.png
homepage: https://joinmastodon.org/

categories: 
- apps/education

description: 
  text: "Mastodon is a free, open-source social network server based on ActivityPub where users can follow friends and discover new ones. On Mastodon, users can publish anything they want: links, pictures, text, video. All Mastodon servers are interoperable as a federated network (users on one server can seamlessly communicate with users from another one, including non-Mastodon software that implements ActivityPub)!"
  short: Free, open-source decentralized social media platform.

globals:
  dbPass: ${fn.password}

nodes:
  nodeType: dockerengine
  nodeGroup: cp
  cloudlets: 32
  fixedcloudlets: 10
  extip: true
  displayName: Mastodon server
  addons: [update-mastodon,mail-setup,s3-setup]
  volumes: ["/root/mastodon"]

settings:
  fields:  
  - caption: Custom Domain
    type: checkbox
    name: use-custom-domain
    value: true
    disabled: false
    tooltip: "If this option is disabled, Mastodon will be configured to use the environment URL for its domain name. Mastodon does not recommend changing domain names after setup."
    showIf:
      true:
        - caption: Domain Name
          type: string
          name: custom-domain-name
  smtp:
    fields:
      - name: smtp-server
        caption: SMTP Server
        type: string
        vtype: email
      - name: smtp-port
        caption: SMTP Port
        type: string
      - name: smtp-login
        caption: SMTP Login
        type: string
      - name: smtp-password
        caption: SMTP Password
        type: string
        inputtype: password
      - name: smtp-from
        caption: From Address
        type: string
  s3:
    fields:
      - name: s3-bucket
        caption: S3 Bucket
        type: string
      - name: aws-access-key-id
        caption: Username
        type: string
      - name: aws-secret-access-key
        caption: Password
        type: string
        inputType: password
      - name: s3-alias-host
        caption: Host
        type: string   

onInstall:
  - setup
  - if (${settings.use-custom-domain:true}): setupCustomDomain
  - start

actions:
  setup:      
    - cmd[cp]: |-
        yum update -y
        mkdir -p /root/mastodon
        cd /root/mastodon
        docker pull lscr.io/linuxserver/mastodon
        SECRET_KEY_BASE=`docker run --rm -w /app/www --entrypoint rake lscr.io/linuxserver/mastodon secret`
        OTP_SECRET=`docker run --rm -w /app/www --entrypoint rake lscr.io/linuxserver/mastodon secret`
        wget https://raw.githubusercontent.com/TaylorJadin/mastodon-docker-jps/main/docker-compose.yml
        wget https://raw.githubusercontent.com/TaylorJadin/mastodon-docker-jps/main/.env
        sed -i \
        -e "s|DOMAIN=|DOMAIN=${env.domain}|" \
        -e "s|LETSENCRYPT_EMAIL=|LETSENCRYPT_EMAIL=${user.email}|" \
        -e "s|DATABASE_PASSWORD=|DATABASE_PASSWORD=${globals.dbPass}|" \
        -e "s|SECRET_KEY_BASE=|SECRET_KEY_BASE=$SECRET_KEY_BASE|" \
        -e "s|OTP_SECRET=|OTP_SECRET=$OTP_SECRET|" \
        -e "/VAPID/d" \
        .env
        docker run --rm -w /app/www --entrypoint rake lscr.io/linuxserver/mastodon mastodon:webpush:generate_vapid_key >> .env
    - env.file.AddFavorite:
        nodeGroup: cp
        path: /root/mastodon
        keyword: mastodon
  setupCustomDomain:
    - cmd[cp]: |-
        cd /root/mastodon
        sed -i \
        -e "s|DOMAIN=|DOMAIN=${settings.custom-domain-name}|" \
        .env
  start:
    - cmd[cp]: |-
        cd /root/mastodon
        docker-compose up -d

addons:
  - id: update-mastodon
    name: Update Mastodon
    description: Pull updated docker containers and restart Mastodon.
    permanent: true
    buttons:
      - confirmText: Are you sure you want to proceed?
        loadingText: Upading Mastodon...
        action: updateMastodon
        caption: Update
        successText: Your Mastodon instance has been updated!
        title: Update Mastodon
    actions:
      updateMastodon:
        -  cmd[cp]: |-
            cd /root/mastodon
            docker-compose pull
            docker-compose down
            docker-compose up -d
  - id: mail-setup
    name: Mail Setup
    description: Configure Mastodon's SMTP settings
    permanent: true
    buttons:
      - confirmText: Are you sure you want to proceed?
        loadingText: Changing Mastodon configuration...
        action: smtpConfigure
        caption: Configure
        successText: Your Mastdon environment has been configured successfully!
        settings: smtp
        title: Please enter your SMTP details
    actions:
      smtpConfigure:
        - cmd[cp]: |-
            cd /root/mastodon
            sed -i \
            -e "s|SMTP_SERVER=.*|SMTP_SERVER=${settings.smtp-server}|" \
            -e "s|SMTP_PORT=.*|SMTP_PORT=${settings.smtp-port}|" \
            -e "s|SMTP_LOGIN=.*|SMTP_LOGIN=${settings.smtp-login}|" \
            -e "s|SMTP_PASSWORD=.*|SMTP_PASSWORD=${settings.smtp-password}|" \
            -e "s|SMTP_FROM_ADDRESS=.*|SMTP_FROM_ADDRESS=${settings.smtp-from}|" \
            .env
            docker-compose up -d --force-recreate
  - id: s3-setup
    name: S3 Setup
    description: Configure S3 Storage
    permanent: true
    buttons:
      - confirmText: Are you sure you want to proceed?
        loadingText: Changing Mastodon configuration...
        action: s3Configure
        caption: Configure
        successText: Your Mastdon environment has been configured successfully!
        settings: s3
        title: Please enter your S3 details
    actions:
      s3Configure:
        - cmd[cp]: |-
            cd /root/mastodon
            sed -i \
            -e "s|S3_ENABLED=.*|S3_ENABLED=true|" \
            -e "s|S3_BUCKET=.*|S3_BUCKET=${settings.s3-bucket}|" \
            -e "s|AWS_ACCESS_KEY_ID=.*|AWS_ACCESS_KEY_ID=${settings.aws-access-key-id}|" \
            -e "s|AWS_SECRET_ACCESS_KEY=.*|AWS_SECRET_ACCESS_KEY=${settings.aws-secret-access-key}|" \
            -e "s|S3_ALIAS_HOST=.*|S3_ALIAS_HOST=${settings.s3-alias-host}|" \
            .env
            docker-compose up -d --force-recreate

success: | 
  - Set up SMTP for Mail and S3 for media storage using the add-ons for your Mastodon server node. 
  - If you are mapping a custom domain, point an A record at **${nodes.cp.extIPs}**.